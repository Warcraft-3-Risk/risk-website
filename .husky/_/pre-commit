#!/bin/sh
. "$(dirname "$0")/./husky.sh"

# Function to show a spinning animation
spin() {
  local pid=$1
  local delay=0.1
  local spinstr='|/-\'
  while ps -p $pid > /dev/null; do
    for char in $spinstr; do
      printf "\r$char"
      sleep $delay
    done
  done
}

echo "ğŸš€ Starting pre-commit checks... Let's go! ğŸ‰"

# Stage 1: ESLint check before staging
echo -n "ğŸ” Running ESLint check... ğŸ§"
npx lint-staged --config lint-staged.eslint.json &
pid=$!
spin $pid

if [ $? -ne 0 ]; then
  echo -e "\nâŒ ESLint check failed... ğŸ˜© Fix errors before committing! ğŸš¨"
  exit 1
fi
echo -e "\nâœ… ESLint check passed! ğŸš€ Moving on..."

# Stage 2: Prettier format on staged files before committing
echo -n "ğŸ¨ Running Prettier on staged files... âœ¨"
npx lint-staged --config lint-staged.prettier.json &
pid=$!
spin $pid

if [ $? -ne 0 ]; then
  echo -e "\nâŒ Prettier formatting failed... ğŸ˜© Please fix formatting issues! ğŸš¨"
  exit 1
fi
echo -e "\nâœ… Prettier formatting applied! âœ¨"

# Only stage files if ESLint and Prettier pass
echo -n "ğŸ“Œ Staging all modified files... ğŸ“"
git add -A &
pid=$!
spin $pid
echo -e "\nâœ… Files staged! ğŸ—‚ï¸"

# Stage 3: Spin up a server (mock)
echo -n "ğŸŒ Starting the server... â³"
sleep 2 &
pid=$!
spin $pid
echo -e "\nâœ… Server started successfully! ğŸˆ All checks are complete."

# Final success message
echo -e "\nğŸ‰âœ¨ LET'S GO â€” WE CAN COMMIT THIS THING!!! ğŸŠğŸ‘ğŸ”¥"